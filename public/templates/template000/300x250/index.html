<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="ad.size" content="width=300,height=250" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="styles.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <script src="manifest.js"></script>

    <!-- VARIABLES -->
    <script type="text/javascript">
      var clickTag = "https://google.com";
      var clickTag1 = "https://google.com/1";
      var clickTag2 = "https://google.com/2";
      var clickTag3 = "https://google.com/3";
      var clickTag4 = "https://google.com/4";
      var clickTag5 = "https://google.com/5";

      var WIDTH = manifest.settings.width;
      var HEIGHT = manifest.settings.height;
      var adID = manifest.settings.adID;
    </script>
    <script src="grid8player.min.js"></script>
    <script src="animate.js"></script>

    <!-- ANIMATIONS -->
    <script>
      function mouseOver(e, t) {
        grid8player.onMouseOver(e, t);
      }

      function mouseOut(e, t) {
        grid8player.onMouseOut(e, t);
      }

      function onClick() {
        console.log("click");

        window.open(dynamicData["s0_website_url"]);
      }
    </script>
    <style>
      /* sdg */
      #level-overlay {
        perspective: 800px;
      }
      .ad970x250 #level-overlay {
        perspective: 1300px;
      }
      .header,
      .sub,
      .cta {
        margin-top: 0px !important;
        overflow: visible !important;
      }
      .cta {
        width: max-content !important;
        height: auto !important;
        background: #4fc3f7;
        padding: 8px 20px 8px 20px;
        border-radius: 15px;
        max-width: 60%;
      }
      .cta {
        overflow: hidden !important;
      }
    </style>
  </head>

  <body>
    <div
      id="ad"
      onmouseenter="mouseOver(event, this)"
      onmouseleave="mouseOut(event, this)"
    ></div>
    <!--<div id="clickLayer" onclick="onClick()"></div>-->
    <!--<div id="border"></div>-->

    <div class="resizable">
      <div class="resizers">
        <div class="rotator-wrapper">
          <div class="rotator"></div>
        </div>
        <div class="resizer top-left"></div>
        <div class="resizer top-right"></div>
        <div class="resizer bottom-left"></div>
        <div class="resizer bottom-right"></div>
      </div>
    </div>

    <div id="debug-panel">
      <div id="slider-wrapper">
        <input
          id="debug-slider"
          type="range"
          min="0"
          max="100"
          value="0"
          class="slider"
        />
      </div>
      <div id="debug-label">0:00/0:00</div>
      <div id="debug-control-bar">
        <button id="debug-back">
          <svg
            style="rotate: 180deg"
            xmlns="http://www.w3.org/2000/svg"
            width="7.678"
            height="9.709"
            viewBox="0 0 7.678 9.709"
          >
            <path
              id="Icon_metro-next"
              data-name="Icon metro-next"
              d="M7.678,0V9.709H5.484V5.259L0,9.3V.4L5.484,4.45V0Z"
              fill="#00004c"
            />
          </svg>
        </button>
        <button id="debug-play">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            id="play-debug-icon"
            width="8.511"
            height="10.851"
            viewBox="0 0 8.511 10.851"
          >
            <path
              id="Icon_ionic-md-play"
              data-name="Icon ionic-md-play"
              d="M6.75,3.656V14.507l8.511-5.425Z"
              transform="translate(-6.75 -3.656)"
              fill="#00004c"
            />
          </svg>

          <svg
            xmlns="http://www.w3.org/2000/svg"
            id="pause-debug-icon"
            style="display: none"
            width="8.678"
            height="10.124"
            viewBox="0 0 8.678 10.124"
          >
            <path
              id="Icon_material-pause"
              data-name="Icon material-pause"
              d="M0,10.124H2.893V0H0ZM5.785,0V10.124H8.678V0Z"
              fill="#00004c"
            />
          </svg>
        </button>

        <button id="debug-forward">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="7.678"
            height="9.709"
            viewBox="0 0 7.678 9.709"
          >
            <path
              id="Icon_metro-next"
              data-name="Icon metro-next"
              d="M19.889,5.784v9.709H17.695v-4.45l-5.484,4.046v-8.9l5.484,4.046V5.784Z"
              transform="translate(-12.211 -5.784)"
              fill="#00004c"
            />
          </svg>
        </button>
      </div>
    </div>
    <script type="text/javascript">
      $("#ad").style.width = WIDTH + "px";
      $("#ad").style.height = HEIGHT + "px";

      var queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      let dynamicData = {};
      urlParams.forEach((value, key) => {
        dynamicData[key] = value;
      });
      grid8player.dynamicData = dynamicData;

      if (
        dynamicData["showDebug"] == "true" ||
        dynamicData["grid8"] == "true"
      ) {
        grid8player.debug(true);
      } else {
        grid8player.init();
      }

      function scaleDebugPanel() {
        const params = new URLSearchParams(window.location.search);
        if (grid8player.bDebugMode != true) return;

        let scale = parseFloat(params.get("scale"));
        console.log("scaling", scale);

        // Calculate scale
        if (scale > 1) scale = 1;
        let s = 1 / scale;

        if (scale == 0 || scale == undefined || scale == 1) {
        } else {
          gsap.set("#debug-panel", { height: `${50 * s}px` });

          gsap.set(".slider", { height: `${20 * s}px` });
          // document.querySelector('input[type="range"]::-webkit-slider-runnable-track').style.height = 2*s+"px";
          // gsap.set('input[type="range"]::-webkit-slider-runnable-track', {"height": `${2 * s}px`});
          // gsap.set('input[type="range"]::-webkit-slider-thumb', {"width": `${15 * s}px`, "height": `${15 * s}px`});
          gsap.set("#debug-control-bar>button", {
            width: `${22 * s}px`,
            height: `${22 * s}px`,
          });
          gsap.set("#debug-control-bar>button>svg", { scale: `${s}` });

          const cssRule = `
            #debug-label{
            font-size:${12 * s}px !important
            }
                input[type="range"]::-webkit-slider-runnable-track {
                  height: ${2 * s}px
                }
                 input[type="range"]::-webkit-slider-thumb {
                  width: ${15 * s}px;
                  height: ${15 * s}px;
                    margin-top: -${7 * s}px;
                }
                `;

          const styleElement = document.createElement("style");
          styleElement.innerHTML = cssRule;
          document.head.appendChild(styleElement);
        }
      }

      scaleDebugPanel();
      setTimeout(() => {
        scaleDebugPanel();
      }, 500);
    </script>

    <!-- SCRIPTS -->
    <script>
      // 1. Calculate relative luminance (how the eye sees brightness)
      const getLuminance = (hex) => {
        const c = hex.replace("#", "");
        const rgb = parseInt(c, 16);
        const r = ((rgb >> 16) & 0xff) / 255;
        const g = ((rgb >> 8) & 0xff) / 255;
        const b = ((rgb >> 0) & 0xff) / 255;

        const a = [r, g, b].map((v) =>
          v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4),
        );
        return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
      };

      // 2. Calculate contrast ratio (1 to 21)
      const getContrast = (hex1, hex2) => {
        if (!hex1 || !hex2) return 0;
        const lum1 = getLuminance(hex1);
        const lum2 = getLuminance(hex2);
        const brightest = Math.max(lum1, lum2);
        const darkest = Math.min(lum1, lum2);
        return (brightest + 0.05) / (darkest + 0.05);
      };
      grid8player.globalScripts = function () {
        /* df */
        var W = manifest.settings.width,
          H = manifest.settings.height,
          g = grid8player,
          tls = g.shotTimelines,
          tl = tls[0],
          d = 0,
          padding = H == 600 ? 10 : 10,
          cops = [],
          he = $(".header"),
          sub = $(".sub"),
          cta = $(".cta"),
          // Use standard selector as this element likely lacks the specific class required by the custom $ function
          gridbg = document.getElementById("grid8-background"),
          cta_words = cta.children ? Array.from(cta.children[0].children) : [],
          height_he = gsap.getProperty(he, "line-height") * he.children.length,
          height_sub =
            gsap.getProperty(sub, "line-height") * sub.children.length,
          height_cta = gsap.getProperty(cta, "offsetHeight"),
          toCenter = Math.round(
            (H -
              (height_he + padding + height_sub + padding * 1.5 + height_cta)) /
              2,
          ),
          centerCta = 0;

        // Apply dynamic colors from URL params
        if (g.dynamicData && g.dynamicData["s0_colors"]) {
          var colors = g.dynamicData["s0_colors"].split("|");
          if (colors.length == 3) {
            let btnBg = colors[0];
            let btnText = colors[1];
            let spareColor = colors[2];

            const currentContrast = getContrast(btnBg, btnText);

            if (currentContrast < 3) {
              // Option A: Keep Background, Swap Text with 3rd color
              const contrastWithSpareText = getContrast(btnBg, spareColor);

              // Option B: Swap Background with 3rd color, Keep Text
              const contrastWithSpareBg = getContrast(spareColor, btnText);

              // Pick the combination that yields the highest readability
              if (
                contrastWithSpareText > currentContrast &&
                contrastWithSpareText > contrastWithSpareBg
              ) {
                btnText = spareColor; // Winner: Change Text
              } else if (contrastWithSpareBg > currentContrast) {
                btnBg = spareColor; // Winner: Change Background
              } else {
                // Emergency Fallback: If 3rd color didn't help either, force Black or White text
                btnText = getLuminance(btnBg) > 0.5 ? "#000000" : "#FFFFFF";
              }
            }
            const brandAccent = colors[2] || colors[0];
            const headlineColor =
              getContrast(brandAccent, "#FFFFFF") > 4 ? "#FFFFFF" : "#000000";

            console.log(getContrast(brandAccent, "#FFFFFF"), headlineColor);
            gsap.set(cta, { backgroundColor: btnBg, color: btnText });
            gsap.set(he, { color: spareColor });
            gsap.set(sub, { color: spareColor });

            gsap.set(gridbg, { backgroundColor: headlineColor });
          } else if (colors.length >= 2) {
            gsap.set(cta, { backgroundColor: colors[0], color: colors[1] });
          } else if (colors.length >= 1) {
            gsap.set(cta, { backgroundColor: colors[0] });
          }
        }

        if (W == 970) {
          toCenter = Math.round((H - (height_he + padding + height_sub)) / 2);
        }
        if (cta.children.length > 1) {
          for (let i = 1; i < cta.children.length; i++) {
            for (let j = 0; j < cta.children[i].children.length; j++) {
              cta_words.push(cta.children[i].children[j]);
            }
          }
        }

        function $(els, id) {
          if (id == undefined) id = 0;
          var arr = [];
          els = document.querySelectorAll(els);
          for (const el of els) {
            if (el.classList.contains("shot-" + id)) arr.push(el); // return el;
          }
          if (arr.length === 0) {
            return false;
          } else if (arr.length === 1) {
            return arr[0];
          } else {
            return arr;
          }
        }

        this.onMouseOver = function () {
          if (gsap.getProperty(".cta", "scale") > 0) {
            gsap.to(".cta", {
              duration: 0.6,
              scale: 1.15,
              ease: "elastic.out(1.2, 0.9)",
            });
            for (let i = 0; i < cta_words.length; i++) {
              let c = cta_words[i];
              gsap.to(c, {
                duration: 0.1,
                y: Math.floor(Math.random() * 2) % 2 ? -8 : 8,
              });
              gsap.to(c, {
                duration: 0.7,
                y: 0,
                ease: "elastic.out(1.1, 0.9)",
                delay: 0.1 + i * 0.05,
              });
            }
          }
        };
        this.onMouseOut = function () {
          if (gsap.getProperty(".cta", "scale") > 0)
            gsap.to(".cta", {
              duration: 0.5,
              scale: 1.0,
              ease: "elastic.out(1.2, 0.9)",
            });
        };

        tl.from(".bgr", { duration: 2.0, scale: 1.2, ease: "expo" }, d);
        tl.to(
          ".bgr",
          {
            duration: 2.0,
            rotateX: "random(-10, 10, 1)",
            rotateY: "random(-15, 15, 1)",
            repeat: 3,
            yoyo: true,
            repeatRefresh: true,
            ease: "sine",
          },
          d,
        );

        d += 0.1;
        tl.from(
          ".logo",
          { duration: 2.0, rotateY: -80 - 180, ease: "elastic(1.3, 0.6)" },
          d,
        );

        d += 0.2;
        gsap.set(he, { y: toCenter });
        gsap.set(sub, { y: gsap.getProperty(he, "y") + height_he + padding });
        gsap.set(cta, {
          y:
            W == 970
              ? Math.round((H - height_cta) / 2)
              : gsap.getProperty(sub, "y") + height_sub + padding * 1.5,
        });
        for (var i = 0; i < he.children.length; i++) {
          for (var j = 0; j < he.children[i].children.length; j++) {
            cops.push(he.children[i].children[j]);
          }
        }

        tl.from(
          cops,
          {
            duration: 0.9,
            y: gsap.getProperty(he, "font-size") * 1.5,
            rotation: 20,
            ease: "expo",
            stagger: 0.125,
          },
          d,
        );
        tl.from(cops, { duration: 1.0, alpha: 0, stagger: 0.125 }, d);

        d += cops.length * 0.125 + 0.3;
        tl.from(
          sub.children,
          {
            duration: 1.0,
            y: gsap.getProperty(sub, "font-size") * 1.5,
            rotationZ: "0.1deg",
            ease: "expo",
            stagger: 0.2,
          },
          d,
        );
        tl.from(sub.children, { duration: 0.8, alpha: 0, stagger: 0.2 }, d);

        d += sub.children.length * 0.2 + 0.2;
        tl.from(
          cta,
          { duration: 0.8, scale: 0, ease: "elastic.out(1.3, 0.8)" },
          d,
        );
        console.log(height_cta);
        tl.from(
          cta_words,
          {
            duration: 1.2,
            y: "+=" + height_cta,
            stagger: 0.15,
            ease: "elastic.out(1.0, 0.9)",
          },
          d,
        );
        tl.from(cta_words, { duration: 0.6, alpha: 0, stagger: 0.15 }, d);
      };
    </script>
    <!-- //SCRIPTS -->
    <!-- CUSTOM EASE -->
    <script></script>
    <!-- /CUSTOM EASE -->
  </body>
</html>
